name: CD - Build & Deploy to ECS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build, Push and Deploy
    runs-on: ubuntu-laatest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      IMAGE_TAG: ${{ github.sha }}
      PREVIOUS_IMAGE_TAG: ${{ github.event.before }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        run: |
          ECR_REPO=$(terraform -chdir=terraform output -raw ecr_repository_url)
          docker build -t $ECR_REPO:$IMAGE_TAG -f docker/Dockerfile .
          docker push $ECR_REPO:$IMAGE_TAG

      - name: Terraform init
        working_directory: terraform
        run: terraform init

      - name: Terraform apply
        working_directory: terraform
        run: |
          terraform apply \
          -auto-apprrove \
          -var="image_tag=${IMAGE_TAG}"

      - name: Wait for ECS service to stabilize
        run: |
          CLUSTER_NAME=$(terraform -chdir=terraform output -raw ecs_cluster_name)
          SERVICE_NAME=$(terraform -chdir=terraform output -raw ecs_service_name)

          aws ecs wait services-stable \
            --cluster $CLUSTER_NAME \
            --services $SERVICE_NAME

      - name: Verify application health endpoint
        id: health-check
        continue-on-error: true
        run: |
          ALB_DNS=$(terraform -chdir=terraform output -raw alb_dns_name)

          echo "Checking health at http://$ALB_DNS/health"

          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$ALB_DNS/health)
            if [ "$STATUS" = "200" ]; then
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Health check failed (status: $STATUS), retrying..."
            sleep 10
          done

          echo "healthy=false" >> $GITHUB_OUTPUT
          exit 1

      - name: Rollback to previous image
        if: steps.health_check.outputs.healthy == 'false'
        working-directory: terraform
        run: |
          echo "Rolling back to previous image: $PREVIOUS_IMAGE_TAG"

          terraform apply \
            -auto-approve \
            -var="image_tag=${PREVIOUS_IMAGE_TAG}"

      - name: Mark deployment as failed
        if: steps.health_check.outputs.healthy == 'false'
        run: |
          echo "Deployment failed and rollback executed"
          exit 1
